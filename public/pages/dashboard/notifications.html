<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông báo - Học Tiếng Đài Loan</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/common/variables.css">
    <link rel="stylesheet" href="/css/common/reset.css">
    <link rel="stylesheet" href="/css/common/utilities.css">
    <link rel="stylesheet" href="/css/components/header.css">
    <link rel="stylesheet" href="/css/components/footer.css">
    <link rel="stylesheet" href="/css/components/buttons.css">
    <link rel="stylesheet" href="/css/components/cards.css">
    <link rel="stylesheet" href="/css/pages/dashboard.css">
    
    <style>
        .notifications-page {
            min-height: 100vh;
            background: #f8f9ff;
        }
        
        .notifications-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .page-header {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .page-header h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .page-header .subtitle {
            color: #666;
            font-size: 0.95rem;
        }
        
        .notifications-filters {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }
        
        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.75rem;
        }
        
        .action-btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-mark-all {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-mark-all:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn-delete-read {
            background: #f87171;
            color: white;
        }
        
        .btn-delete-read:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }
        
        .notifications-list {
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .notification-group {
            border-bottom: 1px solid #f0f0f0;
        }
        
        .notification-group:last-child {
            border-bottom: none;
        }
        
        .group-header {
            background: #f8f9ff;
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .notification-full-item {
            display: flex;
            gap: 1rem;
            padding: 1.25rem 1.5rem;
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }
        
        .notification-full-item:hover {
            background: #f8f9ff;
        }
        
        .notification-full-item.unread {
            background: #f8f9ff;
            border-left-color: #667eea;
        }
        
        .notification-full-item.unread::before {
            content: '';
            position: absolute;
            left: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
        }
        
        .notif-icon-wrapper {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.5rem;
            margin-left: 1rem;
        }
        
        .notif-content {
            flex: 1;
            min-width: 0;
        }
        
        .notif-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .notif-title {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }
        
        .notif-time {
            color: #999;
            font-size: 0.8125rem;
        }
        
        .notif-message {
            color: #666;
            font-size: 0.9375rem;
            line-height: 1.5;
            margin-bottom: 0.75rem;
        }
        
        .notif-action {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            color: #667eea;
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            transition: color 0.2s ease;
        }
        
        .notif-action:hover {
            color: #5568d3;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .delete-btn:hover {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #999;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            opacity: 0.3;
        }
        
        .empty-state h3 {
            color: #666;
            margin-bottom: 0.5rem;
        }
        
        .empty-state p {
            font-size: 0.9375rem;
        }
        
        .loading-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #667eea;
        }
        
        .loading-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 2rem;
            padding: 1rem;
        }
        
        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination .page-info {
            display: flex;
            align-items: center;
            padding: 0 1rem;
            color: #666;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header-placeholder"></div>
    
    <div class="notifications-page">
        <div class="notifications-container">
            <!-- Page Header -->
            <div class="page-header">
                <h1>
                    <i class="fas fa-bell"></i>
                    Thông báo
                </h1>
                <p class="subtitle">Quản lý tất cả thông báo của bạn</p>
            </div>
            
            <!-- Filters & Actions -->
            <div class="notifications-filters">
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">
                        <i class="fas fa-inbox"></i>
                        Tất cả
                    </button>
                    <button class="filter-btn" data-filter="unread">
                        <i class="fas fa-envelope"></i>
                        Chưa đọc
                    </button>
                    <button class="filter-btn" data-filter="achievement">
                        <i class="fas fa-trophy"></i>
                        Thành tích
                    </button>
                    <button class="filter-btn" data-filter="streak">
                        <i class="fas fa-fire"></i>
                        Streak
                    </button>
                    <button class="filter-btn" data-filter="level_up">
                        <i class="fas fa-arrow-up"></i>
                        Level Up
                    </button>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn btn-mark-all" id="markAllReadBtn">
                        <i class="fas fa-check-double"></i>
                        Đánh dấu tất cả
                    </button>
                    <button class="action-btn btn-delete-read" id="deleteReadBtn">
                        <i class="fas fa-trash-alt"></i>
                        Xóa đã đọc
                    </button>
                </div>
            </div>
            
            <!-- Notifications List -->
            <div class="notifications-list" id="notificationsList">
                <div class="loading-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Đang tải thông báo...</p>
                </div>
            </div>
            
            <!-- Pagination -->
            <div class="pagination" id="pagination" style="display: none;">
                <button id="prevBtn" disabled>
                    <i class="fas fa-chevron-left"></i>
                    Trước
                </button>
                <div class="page-info">
                    <span id="pageInfo">Trang 1</span>
                </div>
                <button id="nextBtn">
                    Tiếp
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script type="module">
        import { loadHeader } from '/js/utils/component-loader.js';
        import { api } from '/js/utils/api.js';
        
        let currentFilter = 'all';
        let currentPage = 1;
        const pageSize = 20;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadHeader('dashboard');
            await loadNotifications();
            
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    currentPage = 1;
                    loadNotifications();
                });
            });
            
            // Mark all as read
            document.getElementById('markAllReadBtn').addEventListener('click', markAllAsRead);
            
            // Delete read
            document.getElementById('deleteReadBtn').addEventListener('click', deleteReadNotifications);
            
            // Pagination
            document.getElementById('prevBtn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadNotifications();
                }
            });
            
            document.getElementById('nextBtn').addEventListener('click', () => {
                currentPage++;
                loadNotifications();
            });
        });
        
        async function loadNotifications() {
            const container = document.getElementById('notificationsList');
            container.innerHTML = '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i><p>Đang tải thông báo...</p></div>';
            
            try {
                const skip = (currentPage - 1) * pageSize;
                let endpoint = `/notifications?limit=${pageSize}&skip=${skip}`;
                
                if (currentFilter === 'unread') {
                    endpoint += '&unreadOnly=true';
                }
                
                const response = await api.get(endpoint);
                
                if (response.success) {
                    let notifications = response.data.notifications;
                    
                    // Filter by type if not 'all' or 'unread'
                    if (currentFilter !== 'all' && currentFilter !== 'unread') {
                        notifications = notifications.filter(n => n.type === currentFilter);
                    }
                    
                    displayNotifications(notifications);
                    updatePagination(response.data.total);
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Lỗi tải thông báo</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function displayNotifications(notifications) {
            const container = document.getElementById('notificationsList');
            
            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h3>Không có thông báo</h3>
                        <p>Bạn chưa có thông báo nào trong mục này.</p>
                    </div>
                `;
                return;
            }
            
            // Group by date
            const groups = groupByDate(notifications);
            
            container.innerHTML = '';
            
            Object.keys(groups).forEach(dateLabel => {
                const group = document.createElement('div');
                group.className = 'notification-group';
                
                group.innerHTML = `
                    <div class="group-header">${dateLabel}</div>
                    ${groups[dateLabel].map(notif => createNotificationHTML(notif)).join('')}
                `;
                
                container.appendChild(group);
                
                // Add event listeners
                group.querySelectorAll('.notification-full-item').forEach((item, index) => {
                    const notif = groups[dateLabel][index];
                    item.addEventListener('click', () => handleNotificationClick(notif));
                });
                
                group.querySelectorAll('.delete-btn').forEach((btn, index) => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteNotification(groups[dateLabel][index]._id);
                    });
                });
            });
        }
        
        function groupByDate(notifications) {
            const groups = {};
            const now = new Date();
            
            notifications.forEach(notif => {
                const date = new Date(notif.createdAt);
                const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
                
                let label;
                if (diffDays === 0) label = 'Hôm nay';
                else if (diffDays === 1) label = 'Hôm qua';
                else if (diffDays < 7) label = 'Tuần này';
                else if (diffDays < 30) label = 'Tháng này';
                else label = 'Cũ hơn';
                
                if (!groups[label]) groups[label] = [];
                groups[label].push(notif);
            });
            
            return groups;
        }
        
        function createNotificationHTML(notif) {
            const icon = getNotificationIcon(notif.type, notif.icon);
            const color = notif.color || '#667eea';
            const timeAgo = formatTimeAgo(notif.createdAt);
            
            return `
                <div class="notification-full-item ${notif.isRead ? '' : 'unread'}" data-id="${notif._id}">
                    <div class="notif-icon-wrapper" style="background-color: ${color}20; color: ${color}">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="notif-content">
                        <div class="notif-header">
                            <span class="notif-title">${notif.title || getTypeLabel(notif.type)}</span>
                            <span class="notif-time">${timeAgo}</span>
                        </div>
                        <div class="notif-message">${notif.message}</div>
                        ${notif.actionUrl && notif.actionUrl !== '#' ? `
                            <a href="${notif.actionUrl}" class="notif-action">
                                ${notif.actionLabel || 'Xem chi tiết'}
                                <i class="fas fa-arrow-right"></i>
                            </a>
                        ` : ''}
                    </div>
                    <button class="delete-btn" title="Xóa">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }
        
        function getNotificationIcon(type, customIcon) {
            if (customIcon) return customIcon;
            const icons = {
                achievement: 'fa-trophy',
                streak: 'fa-fire',
                level_up: 'fa-arrow-up',
                reminder: 'fa-clock',
                system: 'fa-bell'
            };
            return icons[type] || 'fa-bell';
        }
        
        function getTypeLabel(type) {
            const labels = {
                achievement: 'Thành tích',
                streak: 'Streak',
                level_up: 'Tăng cấp',
                reminder: 'Nhắc nhở',
                system: 'Hệ thống'
            };
            return labels[type] || 'Thông báo';
        }
        
        function formatTimeAgo(date) {
            const now = new Date();
            const past = new Date(date);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'Vừa xong';
            if (diffMins < 60) return `${diffMins} phút trước`;
            if (diffHours < 24) return `${diffHours} giờ trước`;
            if (diffDays < 7) return `${diffDays} ngày trước`;
            return past.toLocaleDateString('vi-VN');
        }
        
        async function handleNotificationClick(notif) {
            if (!notif.isRead) {
                try {
                    await api.put(`/notifications/${notif._id}/read`);
                    document.querySelector(`[data-id="${notif._id}"]`).classList.remove('unread');
                } catch (error) {
                    console.error('Failed to mark as read:', error);
                }
            }
            
            if (notif.actionUrl && notif.actionUrl !== '#') {
                window.location.href = notif.actionUrl;
            }
        }
        
        async function markAllAsRead() {
            if (!confirm('Đánh dấu tất cả thông báo là đã đọc?')) return;
            
            try {
                const response = await api.put('/notifications/mark-all-read');
                if (response.success) {
                    loadNotifications();
                }
            } catch (error) {
                alert('Lỗi: ' + error.message);
            }
        }
        
        async function deleteReadNotifications() {
            if (!confirm('Xóa tất cả thông báo đã đọc? Hành động này không thể hoàn tác.')) return;
            
            try {
                const response = await api.delete('/notifications/delete-read');
                if (response.success) {
                    loadNotifications();
                }
            } catch (error) {
                alert('Lỗi: ' + error.message);
            }
        }
        
        async function deleteNotification(id) {
            if (!confirm('Xóa thông báo này?')) return;
            
            try {
                await api.delete(`/notifications/${id}`);
                loadNotifications();
            } catch (error) {
                alert('Lỗi: ' + error.message);
            }
        }
        
        function updatePagination(total) {
            const pagination = document.getElementById('pagination');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pageInfo = document.getElementById('pageInfo');
            
            const totalPages = Math.ceil(total / pageSize);
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage >= totalPages;
            pageInfo.textContent = `Trang ${currentPage} / ${totalPages}`;
        }
    </script>
</body>
</html>
